name: CI
permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
  push:
    branches: [master]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.12.0"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run ESLint
        run: yarn lint:check

  prettier:
    name: Prettier
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.12.0"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run Prettier
        run: yarn prettier:check

  prompts-check:
    name: Prompts Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.12.0"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run Langfuse prompt check
        env:
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_BASE_URL: ${{ vars.LANGFUSE_BASE_URL }}
          LANGFUSE_PROMPT_LABEL: ${{ vars.LANGFUSE_PROMPT_LABEL }}
        run: yarn prompts:check

  llm-connections-check:
    name: LLM Connections Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.12.0"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run Langfuse LLM connection check
        env:
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_BASE_URL: ${{ vars.LANGFUSE_BASE_URL }}
          LLM_CONNECTIONS_ENV: ${{ vars.LLM_CONNECTIONS_ENV }}
        run: yarn llm-connections:check

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.12.0"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run Jest
        run: yarn test

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.12.0"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build backend and frontend
        run: yarn build:all

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.12.0"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Get Playwright version
        id: pw-version
        run: |
          pw_version=$(node -p 'require("@playwright/test/package.json").version')
          echo "version=$pw_version" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        id: pw-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.pw-version.outputs.version }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        run: yarn test:e2e

  visual-regression:
    name: Visual Regression
    if: github.event_name == 'pull_request'
    runs-on: windows-latest
    continue-on-error: true
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.12.0"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Get Playwright version
        id: pw-version-visual
        run: |
          pw_version=$(node -p 'require("@playwright/test/package.json").version')
          echo "version=$pw_version" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        id: pw-cache-visual
        uses: actions/cache@v4
        with:
          path: ~/AppData/Local/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.pw-version-visual.outputs.version }}

      - name: Install Playwright browsers
        run: npx playwright install

      - name: Restore baseline snapshots
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1
          git checkout origin/${{ github.base_ref }} -- test/e2e/visual.spec.ts-snapshots || echo "No baseline snapshots found"

      - name: Run visual tests
        id: visual-tests
        continue-on-error: true
        run: yarn test:visual

      - name: Build visual summary
        if: always()
        run: |
          run_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          node scripts/visual/summarize.js --results test-results --output visual-summary.md --run-url "$run_url"

      - name: Upload visual artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-regression
          path: |
            playwright-report
            test-results
            visual-summary.md

      - name: Comment on PR
        if: always() && github.event.pull_request.head.repo.fork == false
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body-file visual-summary.md

      - name: Fail on visual diffs
        if: steps.visual-tests.outcome == 'failure'
        run: exit 1

  code-stats:
    name: Code Stats
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Python version
        id: py-version
        run: |
          python_version=$(python3 -c 'import sys; print("{}.{}".format(sys.version_info.major, sys.version_info.minor))')
          echo "version=$python_version" >> $GITHUB_OUTPUT

      - name: Cache pip (lizard)
        id: pip-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ steps.py-version.outputs.version }}-lizard

      - name: Code stats (scc + lizard)
        run: |
          docker run --rm -v ${{ github.workspace }}:/pwd ghcr.io/boyter/scc:master \
            scc --ci /pwd
          docker run --rm -v ${{ github.workspace }}:/pwd ghcr.io/boyter/scc:master \
            scc --ci --by-file --sort lines /pwd
          python3 -m pip install --quiet lizard
          lizard -l ts -l tsx -l js -l jsx src test

  checkov:
    name: Checkov (Terraform)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.12.0"
          cache: "yarn"

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Run Checkov
        run: yarn checkov
