name: Meeting Notes Bot Deploy

run-name: Meeting Notes Bot Deploy ${{ github.actor }}

on:
  push:
    branches:
      - master

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20.19.2"
          cache: "yarn"
          cache-dependency-path: "yarn.lock"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run ESLint
        run: yarn lint:check

  prettier:
    name: Prettier
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20.19.2"
          cache: "yarn"
          cache-dependency-path: "yarn.lock"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run Prettier
        run: yarn prettier:check

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20.19.2"
          cache: "yarn"
          cache-dependency-path: "yarn.lock"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run Jest
        run: yarn test

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20.19.2"
          cache: "yarn"
          cache-dependency-path: "yarn.lock"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build backend and frontend
        run: yarn build:all

      - name: Verify dist directory exists
        run: |
          if [ ! -d "dist" ]; then
            echo "ERROR: dist directory not found after build!"
            exit 1
          fi
          if [ ! -f "dist/index.js" ]; then
            echo "ERROR: dist/index.js not found after build!"
            exit 1
          fi
          echo "Build artifacts verified successfully"

  code-stats:
    name: Code Stats
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Code stats (scc + lizard)
        run: |
          docker run --rm -v ${{ github.workspace }}:/pwd ghcr.io/boyter/scc:master \
            scc --ci /pwd
          docker run --rm -v ${{ github.workspace }}:/pwd ghcr.io/boyter/scc:master \
            scc --ci --by-file --sort lines /pwd
          python3 -m pip install --quiet lizard
          lizard -l ts -l tsx -l js -l jsx src test

  checkov:
    name: Checkov (Terraform)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Run Checkov
        run: yarn checkov

  prompts-check:
    name: Prompts Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20.19.2"
          cache: "yarn"
          cache-dependency-path: "yarn.lock"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run Langfuse prompt check
        env:
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_BASE_URL: ${{ vars.LANGFUSE_BASE_URL }}
          LANGFUSE_PROMPT_LABEL: ${{ vars.LANGFUSE_PROMPT_LABEL }}
        run: yarn prompts:check

  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20.19.2"
          cache: "yarn"
          cache-dependency-path: "yarn.lock"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests (mock mode)
        run: yarn test:e2e

  deploybackend:
    name: Deploy Backend
    needs:
      [
        lint,
        prettier,
        test,
        build,
        code-stats,
        checkov,
        prompts-check,
        e2e-tests,
      ]
    runs-on: ubuntu-latest
    environment: sandbox
    env:
      ECS_CLUSTER: ${{ vars.ECS_CLUSTER }}
      ECS_SERVICE: ${{ vars.ECS_SERVICE }}
      ECS_TASK_FAMILY: ${{ vars.ECS_TASK_FAMILY }}
      ECS_LOG_GROUP: ${{ vars.ECS_LOG_GROUP }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ vars.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Build a docker container and
          # push it to ECR so that it can
          # be deployed to ECS.
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .

          # Verify the image contains the required files
          echo "Verifying Docker image contents..."
          docker run --rm $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG ls -la dist/index.js || {
            echo "ERROR: dist/index.js not found in Docker image!"
            exit 1
          }

          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Get current task definition
        id: current-task-def
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
        run: |
          CURRENT_TASK_DEF=$(aws ecs describe-services --cluster "$ECS_CLUSTER" --services "$ECS_SERVICE" --region $AWS_REGION | jq -r '.services[0].taskDefinition')
          echo "current_task_def=$CURRENT_TASK_DEF" >> $GITHUB_OUTPUT
          echo "Current task definition: $CURRENT_TASK_DEF"

      - name: Update ECS service with new task definition
        id: update-service
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
          IMAGE: ${{ steps.build-image.outputs.image }}
        run: |
          # Get the current task definition
          TASK_DEFINITION=$(aws ecs describe-task-definition --task-definition "$ECS_TASK_FAMILY" --region $AWS_REGION)

          # Update the container image in the task definition
          NEW_TASK_DEFINITION=$(echo "$TASK_DEFINITION" | jq --arg IMAGE "$IMAGE" '.taskDefinition | .containerDefinitions[0].image = $IMAGE')

          # Clean up the task definition JSON to remove invalid fields
          CLEAN_TASK_DEFINITION=$(echo "$NEW_TASK_DEFINITION" | jq 'del(.status, .taskDefinitionArn, .revision, .registeredAt, .registeredBy, .compatibilities, .requiresAttributes)')

          # Register the new task definition revision
          echo "$CLEAN_TASK_DEFINITION" | jq 'del(.taskDefinitionArn, .status, .revision, .registeredAt, .registeredBy)' > new-task-def.json
          REGISTERED_TASK_DEF=$(aws ecs register-task-definition --cli-input-json file://new-task-def.json)
          NEW_TASK_DEFINITION_ARN=$(echo "$REGISTERED_TASK_DEF" | jq -r '.taskDefinition.taskDefinitionArn')
          echo "new_task_def=$NEW_TASK_DEFINITION_ARN" >> $GITHUB_OUTPUT

          # Update the ECS service to use the new task definition revision
          aws ecs update-service --cluster "$ECS_CLUSTER" --service "$ECS_SERVICE" --task-definition "$NEW_TASK_DEFINITION_ARN" --region $AWS_REGION

      - name: Wait for service stability
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
        run: |
          set -euo pipefail
          echo "Waiting for ECS service to stabilize..."

          if aws ecs wait services-stable --cluster "$ECS_CLUSTER" --services "$ECS_SERVICE" --region "$AWS_REGION"; then
            echo "Service has stabilized successfully!"
            exit 0
          fi

          echo "ERROR: Service failed to stabilize."
          SERVICE_STATUS=$(aws ecs describe-services --cluster "$ECS_CLUSTER" --services "$ECS_SERVICE" --region "$AWS_REGION")
          echo "Recent service events:"
          echo "$SERVICE_STATUS" | jq -r '.services[0].events[0:10][] | .message' || true
          exit 1

      - name: Verify deployment health
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
        run: |
          echo "Verifying deployment health..."

          # Get the running tasks
          RUNNING_TASKS=$(aws ecs list-tasks --cluster "$ECS_CLUSTER" --service-name "$ECS_SERVICE" --desired-status RUNNING --region $AWS_REGION | jq -r '.taskArns[]')

          if [ -z "$RUNNING_TASKS" ]; then
            echo "ERROR: No running tasks found!"
            exit 1
          fi

          # Check CloudWatch logs for startup errors (if available)
          LOG_GROUP="$ECS_LOG_GROUP"
          CURRENT_TIME=$(date +%s000)
          START_TIME=$((CURRENT_TIME - 300000)) # Last 5 minutes

          echo "Checking recent logs for errors..."
          RECENT_LOGS=$(aws logs filter-log-events --log-group-name $LOG_GROUP --start-time $START_TIME --filter-pattern "ERROR" --region $AWS_REGION 2>/dev/null || echo "{}")

          if [ $(echo "$RECENT_LOGS" | jq -r '.events | length') -gt 0 ]; then
            echo "WARNING: Found error logs in the last 5 minutes:"
            echo "$RECENT_LOGS" | jq -r '.events[] | .message' | head -10
          fi

          echo "Deployment completed successfully!"

      - name: Rollback on failure
        if: failure() && steps.update-service.outcome == 'success'
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
          PREVIOUS_TASK_DEF: ${{ steps.current-task-def.outputs.current_task_def }}
        run: |
          echo "Deployment failed! Rolling back to previous task definition: $PREVIOUS_TASK_DEF"

          aws ecs update-service \
            --cluster "$ECS_CLUSTER" \
            --service "$ECS_SERVICE" \
            --task-definition $PREVIOUS_TASK_DEF \
            --region $AWS_REGION

          echo "Rollback initiated. Previous deployment restored."

      - name: Create deployment summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "## ✅ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Deployment time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ❌ Deployment Failed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Failure time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

  deploy-frontend:
    name: Deploy Frontend
    needs:
      [
        lint,
        prettier,
        test,
        build,
        code-stats,
        checkov,
        prompts-check,
        e2e-tests,
      ]
    runs-on: ubuntu-latest
    environment: sandbox
    env:
      VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ vars.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20.19.2"
          cache: "yarn"
          cache-dependency-path: "yarn.lock"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build frontend (Vite)
        run: yarn build:web

      - name: Sync frontend to S3
        env:
          FRONTEND_BUCKET: ${{ vars.FRONTEND_BUCKET }}
        run: |
          if [ -z "$FRONTEND_BUCKET" ]; then
            echo "FRONTEND_BUCKET not set in environment variables"
            exit 1
          fi
          # Long cache for hashed assets; shorter for HTML
          aws s3 sync build/frontend s3://$FRONTEND_BUCKET --delete --exclude "index.html" --cache-control "public,max-age=31536000,immutable"
          aws s3 cp build/frontend/index.html s3://$FRONTEND_BUCKET/index.html --cache-control "public,max-age=600"
          if [ -f build/frontend/manifest.json ]; then
            aws s3 cp build/frontend/manifest.json s3://$FRONTEND_BUCKET/manifest.json --cache-control "public,max-age=600"
          fi

      - name: Invalidate CloudFront
        env:
          FRONTEND_DISTRIBUTION_ID: ${{ vars.FRONTEND_DISTRIBUTION_ID }}
        run: |
          if [ -z "$FRONTEND_DISTRIBUTION_ID" ]; then
            echo "FRONTEND_DISTRIBUTION_ID not set in environment variables"
            exit 1
          fi
          aws cloudfront create-invalidation --distribution-id "$FRONTEND_DISTRIBUTION_ID" --paths "/*"
