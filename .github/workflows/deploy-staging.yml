name: Meeting Notes Bot Deploy (Staging)

run-name: Staging Deploy ${{ github.actor }}

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22.12.0"
          cache: "yarn"
          cache-dependency-path: "yarn.lock"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run linter
        run: yarn lint

  test:
    name: Unit Tests (Non-blocking)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22.12.0"
          cache: "yarn"
          cache-dependency-path: "yarn.lock"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run tests
        id: run-tests
        run: |
          yarn test --passWithNoTests --testPathIgnorePatterns="src/frontend" || echo "test_failed=true" >> $GITHUB_OUTPUT

      - name: Report test results
        if: steps.run-tests.outputs.test_failed == 'true'
        run: |
          echo "::warning::Some tests failed, but continuing with deployment. Please fix failing tests."

  code-stats:
    name: Code Stats
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get Python version
        id: py-version
        run: |
          python_version=$(python3 -c 'import sys; print("{}.{}".format(sys.version_info.major, sys.version_info.minor))')
          echo "version=$python_version" >> $GITHUB_OUTPUT

      - name: Cache pip (lizard)
        id: pip-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ steps.py-version.outputs.version }}-lizard

      - name: Code stats (scc + lizard)
        run: |
          docker run --rm -v ${{ github.workspace }}:/pwd ghcr.io/boyter/scc:master \
            scc --ci /pwd
          docker run --rm -v ${{ github.workspace }}:/pwd ghcr.io/boyter/scc:master \
            scc --ci --by-file --sort lines /pwd
          python3 -m pip install --quiet lizard
          lizard -l ts -l tsx -l js -l jsx src test

  prompts-check:
    name: Prompts Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22.12.0"
          cache: "yarn"
          cache-dependency-path: "yarn.lock"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run Langfuse prompt check
        env:
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_BASE_URL: ${{ vars.LANGFUSE_BASE_URL }}
          LANGFUSE_PROMPT_LABEL: ${{ vars.LANGFUSE_PROMPT_LABEL }}
        run: yarn prompts:check

  llm-connections-check:
    name: LLM Connections Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22.12.0"
          cache: "yarn"
          cache-dependency-path: "yarn.lock"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run Langfuse LLM connection check
        env:
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_BASE_URL: ${{ vars.LANGFUSE_BASE_URL }}
          LLM_CONNECTIONS_ENV: ${{ vars.LLM_CONNECTIONS_ENV }}
        run: yarn llm-connections:check

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22.12.0"
          cache: "yarn"
          cache-dependency-path: "yarn.lock"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build TypeScript
        run: yarn build

      - name: Verify dist directory exists
        run: |
          if [ ! -d "dist" ]; then
            echo "ERROR: dist directory not found after build!"
            exit 1
          fi
          if [ ! -f "dist/index.js" ]; then
            echo "ERROR: dist/index.js not found after build!"
            exit 1
          fi
          echo "Build artifacts verified successfully"

  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    env:
      FRONTEND_SITE_URL: http://127.0.0.1:5173
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22.12.0"
          cache: "yarn"
          cache-dependency-path: "yarn.lock"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Get Playwright version
        id: pw-version
        run: |
          pw_version=$(node -p 'require("@playwright/test/package.json").version')
          echo "version=$pw_version" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        id: pw-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.pw-version.outputs.version }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests (mock mode)
        run: yarn test:e2e

  deploybackend:
    name: Deploy Backend (Staging)
    needs:
      [
        lint,
        test,
        code-stats,
        prompts-check,
        llm-connections-check,
        build,
        e2e-tests,
      ]
    runs-on: ubuntu-latest
    environment: staging
    env:
      ECS_CLUSTER: ${{ vars.ECS_CLUSTER }}
      ECS_SERVICE: ${{ vars.ECS_SERVICE }}
      ECS_TASK_FAMILY: ${{ vars.ECS_TASK_FAMILY }}
      ECS_LOG_GROUP: ${{ vars.ECS_LOG_GROUP }}
      SECRETS_PREFIX: ${{ vars.SECRETS_PREFIX }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ vars.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Preflight Secrets Manager values
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
        run: |
          set -euo pipefail

          SECRETS_PREFIX="${SECRETS_PREFIX:-}"
          if [ -z "$SECRETS_PREFIX" ] && [ -n "${ECS_TASK_FAMILY:-}" ]; then
            SECRETS_PREFIX="${ECS_TASK_FAMILY%-bot-task}"
          fi
          if [ -z "$SECRETS_PREFIX" ]; then
            echo "ERROR: SECRETS_PREFIX is not set and could not be derived."
            exit 1
          fi

          SECRETS=(
            "${SECRETS_PREFIX}/discord-bot-token"
            "${SECRETS_PREFIX}/discord-client-secret"
            "${SECRETS_PREFIX}/oauth-secret"
            "${SECRETS_PREFIX}/openai-api-key"
            "${SECRETS_PREFIX}/langfuse-public-key"
            "${SECRETS_PREFIX}/langfuse-secret-key"
            "${SECRETS_PREFIX}/stripe-secret-key"
            "${SECRETS_PREFIX}/stripe-webhook-secret"
          )

          missing=()
          for secret in "${SECRETS[@]}"; do
            if ! versions=$(aws secretsmanager list-secret-version-ids --secret-id "$secret" --region "$AWS_REGION" 2>/dev/null); then
              missing+=("$secret (missing)")
              continue
            fi
            if ! echo "$versions" | jq -e '.Versions[]? | select(.VersionStages | index("AWSCURRENT"))' >/dev/null; then
              missing+=("$secret (no AWSCURRENT value)")
            fi
          done

          if [ ${#missing[@]} -gt 0 ]; then
            echo "ERROR: Missing or unset Secrets Manager values:"
            printf ' - %s\n' "${missing[@]}"
            exit 1
          fi

          echo "Secrets Manager preflight passed."

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ github.sha }}
          AWS_REGION: ${{ vars.AWS_REGION }}
        run: |
          set -euo pipefail
          IMAGE="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

          if aws ecr describe-images --repository-name "$ECR_REPOSITORY" --image-ids imageTag="$IMAGE_TAG" --region "$AWS_REGION" >/dev/null 2>&1; then
            echo "Image tag already exists, skipping build and push."
            echo "image=$IMAGE" >> $GITHUB_OUTPUT
            exit 0
          fi

          docker build -t "$IMAGE" .
          docker run --rm "$IMAGE" ls -la dist/index.js || {
            echo "ERROR: dist/index.js not found in Docker image!"
            exit 1
          }
          docker push "$IMAGE"
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

      - name: Get current task definition
        id: current-task-def
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
        run: |
          CURRENT_TASK_DEF=$(aws ecs describe-services --cluster "$ECS_CLUSTER" --services "$ECS_SERVICE" --region $AWS_REGION | jq -r '.services[0].taskDefinition')
          echo "current_task_def=$CURRENT_TASK_DEF" >> $GITHUB_OUTPUT
          echo "Current task definition: $CURRENT_TASK_DEF"

      - name: Update ECS service with new task definition
        id: update-service
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
          IMAGE: ${{ steps.build-image.outputs.image }}
        run: |
          TASK_DEFINITION=$(aws ecs describe-task-definition --task-definition "$ECS_TASK_FAMILY" --region $AWS_REGION)
          NEW_TASK_DEFINITION=$(echo "$TASK_DEFINITION" | jq --arg IMAGE "$IMAGE" '.taskDefinition | .containerDefinitions[0].image = $IMAGE')
          CLEAN_TASK_DEFINITION=$(echo "$NEW_TASK_DEFINITION" | jq 'del(.status, .taskDefinitionArn, .revision, .registeredAt, .registeredBy, .compatibilities, .requiresAttributes)')
          echo "$CLEAN_TASK_DEFINITION" | jq 'del(.taskDefinitionArn, .status, .revision, .registeredAt, .registeredBy)' > new-task-def.json
          REGISTERED_TASK_DEF=$(aws ecs register-task-definition --cli-input-json file://new-task-def.json)
          NEW_TASK_DEFINITION_ARN=$(echo "$REGISTERED_TASK_DEF" | jq -r '.taskDefinition.taskDefinitionArn')
          echo "new_task_def=$NEW_TASK_DEFINITION_ARN" >> $GITHUB_OUTPUT
          aws ecs update-service --cluster "$ECS_CLUSTER" --service "$ECS_SERVICE" --task-definition "$NEW_TASK_DEFINITION_ARN" --region $AWS_REGION

      - name: Wait for service stability
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
        run: |
          set -euo pipefail
          echo "Waiting for ECS service to stabilize..."

          if aws ecs wait services-stable --cluster "$ECS_CLUSTER" --services "$ECS_SERVICE" --region "$AWS_REGION"; then
            echo "Service has stabilized successfully!"
            exit 0
          fi

          echo "ERROR: Service failed to stabilize."
          SERVICE_STATUS=$(aws ecs describe-services --cluster "$ECS_CLUSTER" --services "$ECS_SERVICE" --region "$AWS_REGION")
          echo "Recent service events:"
          echo "$SERVICE_STATUS" | jq -r '.services[0].events[0:10][] | .message' || true
          exit 1

      - name: Verify deployment health
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
        run: |
          echo "Verifying deployment health..."
          RUNNING_TASKS=$(aws ecs list-tasks --cluster "$ECS_CLUSTER" --service-name "$ECS_SERVICE" --desired-status RUNNING --region $AWS_REGION | jq -r '.taskArns[]')
          if [ -z "$RUNNING_TASKS" ]; then
            echo "ERROR: No running tasks found!"
            exit 1
          fi
          LOG_GROUP="$ECS_LOG_GROUP"
          CURRENT_TIME=$(date +%s000)
          START_TIME=$((CURRENT_TIME - 300000))
          echo "Checking recent logs for errors..."
          RECENT_LOGS=$(aws logs filter-log-events --log-group-name $LOG_GROUP --start-time $START_TIME --filter-pattern "ERROR" --region $AWS_REGION 2>/dev/null || echo "{}")
          if [ $(echo "$RECENT_LOGS" | jq -r '.events | length') -gt 0 ]; then
            echo "WARNING: Found error logs in the last 5 minutes:"
            echo "$RECENT_LOGS" | jq -r '.events[] | .message' | head -10
          fi
          echo "Deployment completed successfully!"

      - name: Rollback on failure
        if: failure() && steps.update-service.outcome == 'success'
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
          PREVIOUS_TASK_DEF: ${{ steps.current-task-def.outputs.current_task_def }}
        run: |
          echo "Deployment failed! Rolling back to previous task definition: $PREVIOUS_TASK_DEF"
          aws ecs update-service \
            --cluster "$ECS_CLUSTER" \
            --service "$ECS_SERVICE" \
            --task-definition $PREVIOUS_TASK_DEF \
            --region $AWS_REGION
          echo "Rollback initiated. Previous deployment restored."

      - name: Create deployment summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "## ✅ Staging Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Deployment time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ❌ Staging Deployment Failed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Failure time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          fi

  deploy-frontend:
    name: Deploy Frontend (Staging)
    needs:
      [
        lint,
        test,
        code-stats,
        prompts-check,
        llm-connections-check,
        build,
        e2e-tests,
      ]
    runs-on: ubuntu-latest
    environment: staging
    env:
      VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ vars.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22.12.0"
          cache: "yarn"
          cache-dependency-path: "yarn.lock"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build frontend (Vite)
        run: yarn build:web

      - name: Sync frontend to S3
        env:
          FRONTEND_BUCKET: ${{ vars.FRONTEND_BUCKET }}
        run: |
          if [ -z "$FRONTEND_BUCKET" ]; then
            echo "FRONTEND_BUCKET not set in environment variables"
            exit 1
          fi
          aws s3 sync build/frontend s3://$FRONTEND_BUCKET --delete --exclude "index.html" --cache-control "public,max-age=31536000,immutable"
          aws s3 cp build/frontend/index.html s3://$FRONTEND_BUCKET/index.html --cache-control "public,max-age=600"
          if [ -f build/frontend/manifest.json ]; then
            aws s3 cp build/frontend/manifest.json s3://$FRONTEND_BUCKET/manifest.json --cache-control "public,max-age=600"
          fi

      - name: Invalidate CloudFront
        env:
          FRONTEND_DISTRIBUTION_ID: ${{ vars.FRONTEND_DISTRIBUTION_ID }}
        run: |
          if [ -z "$FRONTEND_DISTRIBUTION_ID" ]; then
            echo "FRONTEND_DISTRIBUTION_ID not set in environment variables"
            exit 1
          fi
          aws cloudfront create-invalidation --distribution-id "$FRONTEND_DISTRIBUTION_ID" --paths "/*"
