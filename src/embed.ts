import { MeetingData } from "./types/meeting-data";
import { EmbedBuilder, AttachmentBuilder, ButtonInteraction, TextChannel } from "discord.js";
import { doesFileHaveContent } from "./util";
import { format } from "date-fns";
import { BaseMessageOptions, Message, MessagePayload } from "discord.js/typings";
import { ChunkInfo } from "./types/audio";  // Assuming date-fns is installed for date formatting

export async function sendMeetingEndEmbedToChannel(meeting: MeetingData, channel: TextChannel, chatLogFilePath: string, audioChunks: ChunkInfo[], transcriptionFilePath: string): Promise<void> {
    await channel.send(getEmbed(meeting, chatLogFilePath, audioChunks, transcriptionFilePath));
}


export async function sendMeetingEndEmbed(meeting: MeetingData, interaction: ButtonInteraction, chatLogFilePath: string, audioChunks: ChunkInfo[], transcriptionFilePath: string): Promise<void> {

    await interaction.editReply(getEmbed(meeting, chatLogFilePath, audioChunks, transcriptionFilePath));
}

function getEmbed(meeting: MeetingData, chatLogFilePath: string, audioChunks: ChunkInfo[], transcriptionFilePath: string): BaseMessageOptions {
    const attendanceList = Array.from(meeting.attendance).join('\n');
    const meetingStart = format(meeting.startTime, "PPpp"); // Format the meeting start time
    const meetingEnd = format(meeting.endTime!, "PPpp"); // Current time as the meeting end time
    const meetingDuration = Math.floor((Date.now() - meeting.startTime.getTime()) / 60000); // Duration in minutes

    const embed = new EmbedBuilder()
        .setTitle('ðŸ“‹ Meeting Summary')
        .setColor('#3498db')
        .setDescription('Here are the details of the recent meeting:')
        .addFields(
            { name: 'ðŸ•’ Meeting Start', value: meetingStart, inline: true },
            { name: 'ðŸ•’ Meeting End', value: meetingEnd, inline: true },
            { name: 'â±ï¸ Duration', value: `${meetingDuration} minutes`, inline: true },
            { name: 'ðŸ‘¥ Members in Attendance', value: attendanceList || 'No members recorded.' },
            { name: 'ðŸ”Š Voice Channel', value: `**${meeting.voiceChannel.name}**` },
            { name: 'ðŸ”— GitHub Repository', value: '[View Bot on GitHub](https://github.com/BASIC-BIT/meeting-notes-discord-bot)', inline: true },
            { name: 'â˜• Donate', value: '[Support Me On Kofi](https://ko-fi.com/basicbit)', inline: true }
        )
        // .setFooter({ text: 'Generated by Meeting Notes Bot â€¢ Version 1.0.0', iconURL: 'https://example.com/icon.png' }) // Example footer with version info
        .setTimestamp();

    const files: AttachmentBuilder[] = [];
    if (doesFileHaveContent(chatLogFilePath)) {
        files.push(new AttachmentBuilder(chatLogFilePath).setName('ChatLog.txt'));
    }
    audioChunks.forEach((chunk, index) => {
        files.push(new AttachmentBuilder(chunk.file).setName(`audio_${index+1}.mp3`));
    });
    if (doesFileHaveContent(transcriptionFilePath)) {
        files.push(new AttachmentBuilder(transcriptionFilePath).setName('Transcription.txt'));
    }

    return {
        embeds: [embed],
        files,
    };
}